<!DOCTYPE html>
<html>

<head>
    <title>Cover to Cover</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .centered {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .cover-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .cover-container.liked {
            position: relative;
        }

        #likeButton {
            background-color: #008000;
            color: white;
            border-radius: 50%;
            position: absolute;
            top: calc(50% - 25px);
            left: calc(80%);
            width: 65px;
            height: 65px;
        }

        #likeButton:before {
            content: "\2665";
            font-size: 48px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #xButton {
            background-color: #FF4500;
            color: white;
            border-radius: 50%;
            position: absolute;
            top: calc(50% - 25px);
            right: calc(80% + 10px);
            width: 65px;
            height: 65px;
        }

        .cover-container.liked #xButton {
            position: absolute;
            top: 0;
            right: 0;
        }

        .image-container {
            position: relative;
            display: flex;
            gap: 50px;
            align-items: center;
        }

        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loader-container img {
            position: relative;
            width: 200px;
            height: 190px;
        }

        .loader-container label {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-weight: bold;
            padding: 5px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="loader-container">
        <img src="http://www.alexpatten.me/wp-content/uploads/2023/05/bookload.gif" alt="Loader"
            style="width: 200px; height: 190px;">
        <label>Loading...</label>
    </div>
    <div class="centered" style="margin-bottom: 10px;">
        <label for="subjects" style="margin-right: 5px;">Select a subject:</label>
        <select id="genreCombo" style="margin-left: 5px;">
            <option value="action">Action</option>
            <option value="comedy">Comedy</option>
            <option value="drama">Drama</option>
            <option value="fantasy">Fantasy</option>
            <option value="horror">Horror</option>
            <option value="romance">Romance</option>
            <option value="sci-fi">Science Fiction</option>
        </select>
    </div>
    <div class="cover-container" style="margin-bottom: 10px;">
        <button id="likeButton"></button>
        <div id="coverImage"></div>
        <button id="xButton" style="font-size: 24px; font-weight: bold;">X</button>
    </div>
    <div class="text-container">
        <h3 id="titleLabel"></h3>
        <p id="authorLabel"></p>
        <p id="pagesLabel"></p>
        <p id="descriptionLabel"></p>
    </div>
    <div class="image-container">
        <p id="amazonImg">
            <a>
                <img src="http://www.alexpatten.me/wp-content/uploads/2023/05/amazon.png" alt="Amazon Image"
                    style="width: 440px; height: 140px; margin-bottom: 10px;">
            </a>
        </p>
        <p id="goodReadsImg">
            <a>
                <img src="http://www.alexpatten.me/wp-content/uploads/2023/05/goodreads.png" alt="Goodreads Image"
                    style="width: 256px; height: 170px; margin-bottom: 10px;">
            </a>
        </p>
        <p id="googleImg">
            <a>
                <img src="http://www.alexpatten.me/wp-content/uploads/2023/05/google.png" alt="Google Image"
                    style="width: 256px; height: 60px; margin-bottom: 10px;">
            </a>
        </p>
    </div>
    <script>
        var workCount = 0; // Global variable for storing the work count
        var storedBooks = []; // Global variable for storing books
        var index = 0; // Initial index
        var usedIndexes = []; // Global array to keep track of used offsets
        var moreInfo = false;
        let randomBook = null; // Declare randomBook as a global variable

        // Function to update the cover image
        function updateCoverImage(imageUrl) {
            const coverImageBox = $('#coverImageBox');
            const coverImage = $('#coverImage');

            // Set the background image of the coverImageBox
            coverImageBox.css('background-image', `url(${imageUrl})`);

            // Stretch the cover image to fit inside the coverImageBox
            coverImage.css({
                'background-image': `url(${imageUrl})`,
                'background-size': 'cover',
                'background-position': 'center',
            });
        }

        // Function to retrieve the work count
        function getWorkCount(encodedGenre) {
            const loaderContainer = document.querySelector('.loader-container');
            loaderContainer.style.display = 'flex';
            // Call the Open Library API to get the work count
            fetch(`https://openlibrary.org/subjects/${encodedGenre}.json?limit=1`)
                .then(response => response.json())
                .then(data => {
                    // Store the result from work_count as a global variable
                    workCount = data.work_count;
                    // Hide the loader container after the async operation is complete
                    loaderContainer.style.display = 'none';
                })
                .catch(error => console.log(error));
        }

        // Function to retrieve a random book
        function getRandomBook(encodedGenre, usedIndexes) {
            const loaderContainer = document.querySelector('.loader-container');
            loaderContainer.style.display = 'flex';

            // Function to check if a number exists in the usedIndexes array
            function isIndexUsed(num) {
                return usedIndexes.includes(num);
            }

            // Generate a random unique index
            function generateUniqueIndex() {
                const newIndex = Math.floor(Math.random() * workCount);
                const range = Array.from({ length: 15 }, (_, i) => newIndex + i);
                if (range.some(isIndexUsed)) {
                    return generateUniqueIndex();
                }
                return newIndex;
            }

            // Update the index as a random unique integer between 0 and workCount
            const index = generateUniqueIndex();

            // Add the current index and the range index to usedIndexes
            for (var i = index; i < index + 15; i++) {
                usedIndexes.push(i);
            }

            // Call the Open Library API to get 15 random books
            return fetch(`https://openlibrary.org/subjects/${encodedGenre}.json?limit=15&offset=${index}`)
                .then(response => response.json())
                .then(data => {
                    // Store the JSON results horizontally in the storedBooks array
                    storedBooks = data.works.map(work => ({
                        first_publish_year: work.first_publish_year,
                        author_name: work.authors[0].name,
                        title: work.title,
                        isbn: work.isbn,
                        cover_id: work.cover_id
                    }));

                    // Hide the loader container after the async operation is complete
                    loaderContainer.style.display = 'none';

                    return usedIndexes; // Return the updated usedIndexes array
                })
                .catch(error => {
                    console.log(error);
                    return usedIndexes; // Return the original usedIndexes array on error
                });
        }

        function updateBookDetails(encodedGenre, usedIndexes) {
            const titleLabel = $('#titleLabel');
            const descriptionLabel = $('#descriptionLabel');
            const authorLabel = $('#authorLabel');
            const pagesLabel = $('#pagesLabel');
            const amazonImg = $('#amazonImg a');
            const goodReadsImg = $('#goodReadsImg a');

            if (titleLabel !== '') {
                randomBook = null;
            }
            if (randomBook === null) {
                randomBook = storedBooks[Math.floor(Math.random() * storedBooks.length)];
            }

            let bookIndex = storedBooks.indexOf(randomBook); // Get the index of randomBook

            if (!moreInfo) {
                moreInfo = true;
                amazonImg.removeAttr('href');
                goodReadsImg.removeAttr('href');
                if (!randomBook.first_publish_year || randomBook.first_publish_year < 1965) {
                    if (bookIndex > -1) {
                        storedBooks.splice(bookIndex, 1);
                    }
                    getRandomBook(); // Call getRandomBook to get a new random book
                    updateBookDetails(encodedGenre, usedIndexes); // Recursive call to updateBookDetails
                } else {
                    titleLabel.text(`Title: ${randomBook.title}`);
                    authorLabel.text(`Author: ${randomBook.author_name}`);
                    if (randomBook.description) {
                        descriptionLabel.text(randomBook.description);
                    }
                    const coverImageUrl = `https://covers.openlibrary.org/b/id/${randomBook.cover_id}.jpg`;
                    updateCoverImage(coverImageUrl);
                }

                // Remove randomBook from storedBooks array
                if (bookIndex > -1) {
                    storedBooks.splice(bookIndex, 1);
                }

            } else {
                const title = encodeURIComponent(`"${titleLabel.text().trim().replace('Title: ', '')}"`);
                const author = encodeURIComponent(`"${authorLabel.text().trim().replace('Author: ', '')}"`);
                const amazonUrl = `https://www.amazon.com/s?k=${title}+${author}`.replace(/ /g, '+');
                const goodreadsUrl = `https://www.goodreads.com/search?q=${title}+${author}`.replace(/ /g, '+');

                amazonImg.html(`<a href="${amazonUrl}" target="_blank"><img src="http://www.alexpatten.me/wp-content/uploads/2023/05/amazon.png" alt="Amazon Image" style="width: 440px; height: 140px; margin-bottom: 10px;"></a>`);
                goodReadsImg.html(`<a href="${goodreadsUrl}" target="_blank"><img src="http://www.alexpatten.me/wp-content/uploads/2023/05/goodreads.png" alt="Goodreads Image" style="width: 256px; height: 170px; margin-bottom: 10px;"></a>`);

                moreInfo = false;
            }

            $('#coverImage').removeClass('hidden');
            $('#likeButton').addClass('hidden');
            $('#xButton').removeClass('hidden');
        }

        $(document).ready(function () {
            const genreCombo = document.getElementById('genreCombo');
            const usedIndexes = [];
            let encodedGenre = ''; // Declare encodedGenre outside the updateOnGenreChange function

            function updateOnGenreChange() {
                const selectedGenre = genreCombo.value;
                encodedGenre = selectedGenre.replace(/\s/g, '%20');
                usedIndexes.length = 0; // Clear the usedIndexes array

                getWorkCount(encodedGenre); // Call getWorkCount when genreCombo is changed
                getRandomBook(encodedGenre, usedIndexes).then(updatedUsedIndexes => {
                    // Store the updated usedIndexes array
                    usedIndexes.push(...updatedUsedIndexes);

                    // Call updateBookDetails when genreCombo is changed
                    updateBookDetails(encodedGenre, usedIndexes);
                });
            }

            // Call updateOnGenreChange on page load
            updateOnGenreChange();

            genreCombo.addEventListener('change', updateOnGenreChange);

            $('#likeButton').on('click', function () {
                updateBookDetails(encodedGenre, usedIndexes); // Call the function when the button is clicked
            });
        });

        $('#xButton').on('click', function () {
            moreInfo = false;
            $('#descriptionLabel').text(''); // Clear the descriptionLabel
            updateBookDetails();
            $('#coverImage').addClass('hidden');
            $('#likeButton').removeClass('hidden');
            $('#xButton').addClass('hidden');
        });

        // Adding a new image box element to the DOM
        const coverImageBox = $('<div></div>').attr('id', 'coverImageBox').insertAfter('#likeButton');

        // Adding a cover image element to the new image box element
        const coverImage = $('<div></div>').attr('id', 'coverImage').appendTo(coverImageBox);

        // Adding an X button element to the new image box element
        const xButton = $('<button>X</button>').attr('id', 'xButton').appendTo(coverImageBox);

        // Styling the new image box and cover image
        $('#coverImageBox').css({
            'display': 'inline-flex',
            'width': '310px',
            'height': '450px',
            'margin-right': '10px',
            'background-color': '#f2f2f2',
            'background-size': 'cover',
            'background-position': 'center',
            'justify-content': 'center',
            'align-items': 'center',
        });

        $('#coverImage').css({
            'width': '510px',
            'height': '450px',
            'background-size': 'cover',
            'background-position': 'center',
        });

        $('#xButton').css({
            'margin-left': '10px',
        });

    </script>
</body>

</html>