<!DOCTYPE html>
<html>

<head>
    <title>My Page</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .centered {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .cover-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .cover-container.liked {
            position: relative;
        }

        #likeButton {
            background-color: #008000;
            color: white;
            border-radius: 50%;
            position: absolute;
            top: calc(50% - 25px);
            left: calc(80%);
            width: 65px;
            height: 65px;
        }

        #likeButton:before {
            content: "\2665";
            font-size: 48px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #xButton {
            background-color: #FF4500;
            color: white;
            border-radius: 50%;
            position: absolute;
            top: calc(50% - 25px);
            right: calc(80% + 10px);
            width: 65px;
            height: 65px;
        }

        .cover-container.liked #xButton {
            position: absolute;
            top: 0;
            right: 0;
        }

        .image-container {
            position: relative;
            display: flex;
            gap: 50px;
            align-items: center;
        }

        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loader-container img {
            position: relative;
            width: 200px;
            height: 190px;
        }

        .loader-container label {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-weight: bold;
            padding: 5px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="loader-container">
        <img src="http://www.alexpatten.me/wp-content/uploads/2023/05/bookload.gif" alt="Loader"
            style="width: 200px; height: 190px;">
        <label>Loading...</label>
    </div>
    <div class="centered" style="margin-bottom: 10px;">
        <label for="subjects" style="margin-right: 5px;">Select a subject:</label>
        <select id="genreCombo" style="margin-left: 5px;"></select>
    </div>
    <div class="cover-container" style="margin-bottom: 10px;">
        <button id="likeButton"></button>
        <div id="coverImage"></div>
        <button id="xButton" style="font-size: 24px; font-weight: bold;">X</button>
    </div>
    <div class="text-container">
        <h3 id="titleLabel"></h3>
        <p id="authorLabel"></p>
        <p id="pagesLabel"></p>
        <p id="descriptionLabel"></p>
    </div>
    <div class="image-container">
        <p id="amazonImg">
            <a>
                <img src="http://www.alexpatten.me/wp-content/uploads/2023/05/amazon.png" alt="Amazon Image"
                    style="width: 440px; height: 140px; margin-bottom: 10px;">
            </a>
        </p>
        <p id="goodReadsImg">
            <a>
                <img src="http://www.alexpatten.me/wp-content/uploads/2023/05/goodreads.png" alt="Goodreads Image"
                    style="width: 256px; height: 170px; margin-bottom: 10px;">
            </a>
        </p>
        <p id="googleImg">
            <a>
                <img src="http://www.alexpatten.me/wp-content/uploads/2023/05/google.png" alt="Google Image"
                    style="width: 256px; height: 60px; margin-bottom: 10px;">
            </a>
        </p>
    </div>

    <script>
        let seenBooks = new Set();
        let currentPage = 1;
        const booksPerPage = 100;
        let totalBooks = 0;
        let currentISBN = null; // Variable to store the ISBN
        // Get a reference to the select element
        var genreCombo = document.getElementById("genreCombo");

        function getRandomBook() {
            if (totalBooks > 0 && seenBooks.size === totalBooks) {
                console.log('All books seen, resetting set.');
                seenBooks.clear();
                currentPage = 1;
            }

            const startIndex = (currentPage - 1) * booksPerPage;
            const selectedGenre = document.getElementById('genreCombo').value;
            const encodedGenre = selectedGenre.replace(/\s/g, '%20'); // Replace spaces with %20
            const url = `https://openlibrary.org/search.json?q=subject:${encodedGenre}&limit=${booksPerPage}&start=${startIndex}`;

            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    totalBooks = data.numFound;
                    const books = data.docs.filter(book => !seenBooks.has(book.key));
                    if (books.length === 0) {
                        console.log('No unseen books found on the current page.');
                        currentPage++;
                        return getRandomBook();
                    }
                    const randomIndex = Math.floor(Math.random() * books.length);
                    const randomBook = books[randomIndex];
                    seenBooks.add(randomBook.key);
                    return randomBook;
                })
                .catch(error => {
                    console.error(error);
                });
        }

        function updateBookDetails() {
            const loaderContainer = document.querySelector('.loader-container');
            const titleLabel = $('#titleLabel');
            const descriptionLabel = $('#descriptionLabel');
            const authorLabel = $('#authorLabel');
            const pagesLabel = $('#pagesLabel');
            const amazonImg = $('#amazonImg a');
            const goodReadsImg = $('#goodReadsImg a');

            loaderContainer.style.display = 'flex';

            if (!currentISBN) {
                getRandomBook()
                    .then(book => {
                        const isbn = book.isbn?.[0] || null;
                        currentISBN = isbn ? (isbn.length === 13 ? isbn.substring(3) : isbn) : null;
                        $('#coverImage').css('background-image', `url(${book.cover_i ? 'https://covers.openlibrary.org/b/id/' + book.cover_i + '-M.jpg' : 'https://www.alexpatten.me/wp-content/themes/personalias/img/thumb-large.png'})`);
                        titleLabel.text(`Title: ${book.title || 'Unknown'}`);
                        authorLabel.text(`Author: ${book.author_name || 'Unknown'}`);
                        descriptionLabel.text('');
                        pagesLabel.text('');
                        amazonImg.removeAttr('href');
                        goodReadsImg.removeAttr('href');

                        // Hide the loader container after the async operation is complete
                        loaderContainer.style.display = 'none';
                    });
            } else {
                updateInfo();
                const title = encodeURIComponent(`"${titleLabel.text().trim().replace('Title: ', '')}"`); // Encode the title
                const author = encodeURIComponent(`"${authorLabel.text().trim().replace('Author: ', '')}"`); // Encode the author
                const amazonUrl = `https://www.amazon.com/s?k=${title}+${author}`.replace(/ /g, '+');
                const goodreadsUrl = `https://www.goodreads.com/search?q=${title}+${author}`.replace(/ /g, '+');
                // Add href to anchor tags
                amazonImg.attr('href', amazonUrl).attr('target', '_blank');
                goodReadsImg.attr('href', goodreadsUrl).attr('target', '_blank');

                currentISBN = null;
            }

            $('#coverImage').removeClass('hidden');
            $('#likeButton').addClass('hidden');
            $('#xButton').removeClass('hidden');
        }


        // Add an event listener to the select element
        genreCombo.addEventListener("change", function () {
            // Update currentISBN to null when the select element is changed
            currentISBN = null;
            // Call the updateBook function
            updateBookDetails();
        });

        function updateInfo() {
            const loaderContainer = document.querySelector('.loader-container');
            if (currentISBN) {
                // Make a request to Google Books API to fetch book details based on ISBN
                const googleBooksUrl = `https://www.googleapis.com/books/v1/volumes?q=isbn:${currentISBN}`;

                fetch(googleBooksUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.totalItems > 0) {
                            const volumeInfo = data.items[0].volumeInfo;
                            const description = volumeInfo.description || 'None';
                            const pageCount = volumeInfo.pageCount || 'Unknown'; // Retrieve the number of pages
                            const previewLink = volumeInfo.previewLink || null; // Retrieve the previewLink

                            $('#descriptionLabel').text(`Description: ${description}`);
                            $('#pagesLabel').text(`Pages: ${pageCount}`); // Update the pagesLabel
                            $('#googleImg a').attr('href', previewLink).attr('target', '_blank'); // Update href of googleImg with previewLink
                        } else {
                            $('#descriptionLabel').text('Description: None');
                            $('#pagesLabel').text('Pages: Unknown'); // Set pagesLabel to 'Unknown'
                            $('#googleImg a').removeAttr('href'); // Remove href from googleImg if book not found
                        }

                        // Hide the loader container after the async operation is complete
                        loaderContainer.style.display = 'none';
                    })
                    .catch(error => {
                        console.error(error);
                        $('#descriptionLabel').text('Description: None');
                        $('#pagesLabel').text('Pages: Unknown'); // Set pagesLabel to 'Unknown' in case of an error
                        $('#googleImg a').removeAttr('href'); // Remove href from googleImg if book not found
                        // Hide the loader container after the async operation is complete
                        loaderContainer.style.display = 'none';
                    });
            } else {
                $('#descriptionLabel').text('Description: None');
                $('#pagesLabel').text('Pages: Unknown'); // Set pagesLabel to 'Unknown' when currentISBN is empty
                $('#googleImg a').removeAttr('href'); // Remove href from googleImg if book not found

                // Hide the loader container after the async operation is complete
                loaderContainer.style.display = 'none';
            }
        }

        $(document).ready(function () {
            updateBookDetails(); // Call the function on page load

            $('#likeButton').on('click', function () {
                updateBookDetails(); // Call the function when the button is clicked
            });
        });

        $('#xButton').on('click', function () {
            currentISBN = null;
            $('#descriptionLabel').text(''); // Clear the descriptionLabel
            updateBookDetails();
            $('#coverImage').addClass('hidden');
            $('#likeButton').removeClass('hidden');
            $('#xButton').addClass('hidden');
        });

        // Adding a new image box element to the DOM
        const coverImageBox = $('<div></div>').attr('id', 'coverImageBox').insertAfter('#likeButton');

        // Adding a cover image element to the new image box element
        const coverImage = $('<div></div>').attr('id', 'coverImage').appendTo(coverImageBox);

        // Adding an X button element to the new image box element
        const xButton = $('<button>X</button>').attr('id', 'xButton').appendTo(coverImageBox);

        // Styling the new image box and cover image
        $('#coverImageBox').css({
            'display': 'inline-flex',
            'width': '310px',
            'height': '450px',
            'margin-right': '10px',
            'background-color': '#f2f2f2',
            'background-size': 'cover',
            'background-position': 'center',
            'justify-content': 'center',
            'align-items': 'center',
        });

        $('#coverImage').css({
            'width': '510px',
            'height': '450px',
            'background-size': 'cover',
            'background-position': 'center',
        });

        $('#xButton').css({
            'margin-left': '10px',
        });
    </script>
</body>

</html>